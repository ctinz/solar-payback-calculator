"""
Train Ridge Regression model for solar production prediction.
Saves model to models/ridge_model.joblib
"""

import pandas as pd
import numpy as np
from io import StringIO
from sklearn.linear_model import Ridge
from sklearn.preprocessing import StandardScaler
from sklearn.model_selection import GroupShuffleSplit
from sklearn.metrics import r2_score, mean_absolute_error, mean_squared_error
import joblib
import os

# Training data from NREL PVDAQ
DATA_STR = """system_id	zip	latitude	longitude	dc_capacity_kW	annual_production_kwh	year	tilt	azimuth	shade
42749	06470	41.4015	-73.3954	24.525	19732	2025	34	279	1
42749	06470	41.4015	-73.3954	24.525	19689	2024	34	279	1
42749	06470	41.4015	-73.3954	24.525	19669	2023	34	279	1
42749	06470	41.4015	-73.3954	24.525	20791	2022	34	279	1
42749	06470	41.4015	-73.3954	24.525	20297	2021	34	279	1
42054	06437	41.5623	-72.4453	15.08	16657	2025	42	320	1
42054	06437	41.5623	-72.4453	15.08	17726	2024	42	320	1
42054	06437	41.5623	-72.4453	15.08	17294	2023	42	320	1
42054	06437	41.5623	-72.4453	15.08	18766	2022	42	320	1
42054	06437	41.5623	-72.4453	15.08	17563	2021	42	320	1
51744	06426	41.3762	-72.1009	15.75	16115	2025	30	180	3
51744	06426	41.3762	-72.1009	15.75	14892	2024	30	180	3
51744	06426	41.3762	-72.1009	15.75	16991	2023	30	180	3
51744	06426	41.3762	-72.1009	15.75	18575	2022	30	180	3
51744	06426	41.3762	-72.1009	15.75	17742	2021	30	180	3
19068	06084	41.7562	-72.7887	11.04	12644	2021	30	135	0
19068	06084	41.7562	-72.7887	11.04	13082	2020	30	135	0
19068	06084	41.7562	-72.7887	11.04	12923	2019	30	135	0
19068	06084	41.7562	-72.7887	11.04	11945	2018	30	135	0
19068	06084	41.7562	-72.7887	11.04	12199	2017	30	135	0
56249	06611	41.1865	-73.1952	14.5	13698	2025	23	100	3
56249	06611	41.1865	-73.1952	14.5	14320	2024	23	100	3
56249	06611	41.1865	-73.1952	14.5	12320	2023	23	100	3
56249	06611	41.1865	-73.1952	14.5	12568	2022	23	100	3
56249	06611	41.1865	-73.1952	14.5	15242	2021	23	100	3
56249	06611	41.1865	-73.1952	14.5	14250	2020	23	100	3
59769	06880	41.1155	-73.3582	12.395	15120	2025	26	205	0
16470	06782	41.6001	-73.2076	6.3	8555	2025	45	180	0
17026	06415	41.3506	-72.3342	11.349	10222	2025	45	225	1
29838	06518	41.3037	-72.9279	7.5	8039	2025	60	180	0
51669	06040	41.8043	-72.7454	10.325	11591	2025	23	200	0
42749	06355	41.3554	-72.0995	10.385	14201	2025	34	279	1
33962	06032	41.8709	-72.8287	7.2	6043	2025	37	168	1
42473	06074	41.8798	-72.5426	8.84	8106	2025	19	208	1
82364	06410	41.5437	-72.8232	10.8	13647	2025	40	118	0
53905	06405	41.2876	-72.5514	5.4	6766	2025	12	235	1
57087	06082	41.8856	-72.7493	5.8	6935	2025	1	180	0
59660	02878	41.7751	-71.4662	8.125	9958	2025	26	205	0
41942	02828	41.5582	-71.6023	8.06	8484	2022	27	159	2
86011	02909	41.824	-71.4128	10.54	9360	2025	32	360	1
46946	02822	41.5804	-71.5162	5.67	6933	2025	30	205	0
91954	02896	41.4901	-71.534	9.28	9380	2025	30	180	1
45868	02061	42.1251	-71.1828	24.96	24285	2025	33	221	1
46582	02151	42.3751	-71.0245	17.755	21534	2025	30	201.5	0
23394	01742	42.4668	-71.3631	14.3	13425	2024	45	182	1
23297	01742	42.4668	-71.3631	13.78	11660	2023	1	225	0
42244	02420	42.3876	-71.1995	12.96	16384	2024	1	193	0
50302	02648	41.7003	-70.2994	17.04	16601	2025	30	125	0
6035	01742	42.4668	-71.3631	9.912	10712	2024	18.5	180	3
44393	01569	42.2084	-71.9073	17.595	15696	2025	1	260	1
46237	02169	42.2501	-71.1828	14.04	13694	2024	32.5	185	2
16970	01742	42.4668	-71.3631	12.48	11259	2023	45	180	1
68960	05446	44.6092	-73.0951	30.24	33668	2023	40	180	1
33202	05465	44.4282	-73.1817	15.08	12845	2025	40	180	0
15858	05401	44.4759	-73.2121	9.31	10169	2025	23	180	1
62043	05482	44.4667	-73.0873	16.05	14102	2024	35	270	1
68963	05443	44.2645	-73.1762	10	11948	2025	45	0	0
57736	05055	43.6401	-72.5167	10.64	11437	2025	30	225	1
10877	05465	44.4282	-73.1817	6.3	6403	2024	30	180	0
6576	05495	44.4501	-73.1695	4.32	4873	2025	26.6	180	0
33203	05465	44.4282	-73.1817	6.76	6115	2025	40	0	0
52510	05477	44.3876	-72.9959	10.137	7340	2025	28	202	1
91180	03278	43.5287	-71.4703	113.4	125508	2024	0	180	0
91181	03278	43.5287	-71.4703	114	129349	2023	0	180	0
72274	03281	43.2951	-71.537	16.64	24408	2024	36	180	1
42154	03055	42.8959	-71.4634	11.4	15331	2024	40	180	0
52014	03077	42.8334	-71.0878	14.79	13384	2025	45	223	1
42157	03841	43.0398	-70.8731	12.88	11611	2025	22	90	1
24723	03885	43.6156	-71.0925	7.8	8154	2025	40	245	0
35563	03841	43.0398	-70.8731	9.1	7493	2024	42	180	2
37169	03811	43.0784	-70.8789	8.4	8515	2024	37	225	0
21612	03110	42.8876	-71.4495	5.808	6724	2024	34	225	1
49967	04981	44.5492	-69.632	14.4	17199	2017	1	180	1
61165	04032	43.8945	-70.0589	14.52	17459	2025	26	165	0
18219	04073	43.5851	-70.4495	8.225	9688	2023	34	180	0
20477	04105	43.6615	-70.2562	6.885	8184	2021	22.6	210	0
63294	04005	43.4857	-70.4983	10.89	10832	2025	1	225	0
80526	04021	43.9015	-70.2371	13.035	13799	2025	45	180	0
82252	04021	43.9015	-70.2371	13.02	13544	2023	0	135	0
82540	04401	44.8012	-68.7778	14.7	10628	2024	0	0	0
54045	04062	43.6334	-70.4776	5.12	4850	2025	33.3	180	2
72155	04105	43.6615	-70.2562	8.67	7539	2024	1	225	1
47886	04105	43.6615	-70.2562	9.18	11672	2017	40	180	0
105975	04270	44.0501	-70.2148	9.12	11346	2025	35	180	0
13195	04217	44.3673	-70.8426	1.48	1870	2014	30	180	0
86577	06791	41.6877	-73.0843	6.6	9337	2024	0	180	0
106345	06877	41.2687	-73.497	20.5	16547	2025	0	0	1
106335	06457	41.5335	-72.6512	11.9	11911	2025	0	0	0
59039	06082	41.9871	-72.5545	7.015	5537	2019	22	90	1
29672	06010	41.6864	-72.9376	1.41	2133	2016	1	180	0
52305	02559	41.6902	-70.6163	14.175	14322	2025	1	0	1
42821	01845	42.6739	-71.0913	11	13336	2024	23	203	0
42773	02421	42.4385	-71.2396	10.72	11605	2024	42	201	1
48131	01564	42.4479	-71.776	9.6	12599	2024	35	180	0
50406	01890	42.4528	-71.1443	10.35	11381	2025	39	135	0
37201	01746	42.196	-71.4534	8.82	10408	2025	42	242	1
38287	01772	42.3029	-71.5308	8.829	10052	2025	25	260	0
5853	01742	42.4629	-71.3645	8.325	8562	2024	43	135	1
47461	02360	41.8821	-70.6313	11.66	12769	2024	23	225	0
49347	01983	42.6414	-70.9434	9.92	12499	2024	30	180	0
2088	01752	42.3496	-71.5472	6.9	7056	2021	35	225	0
58803	01801	42.4887	-71.1544	11.39	13531	2025	1	225	0
15650	02090	42.2196	-71.2168	7.75	8679	2020	28	180	1
54290	01450	42.6116	-71.5647	9.24	12109	2020	36	170	0
39221	01915	42.5707	-70.8676	14.96	13678	2022	1	180	0
56629	01938	42.6839	-70.8427	9.92	12455	2025	1	180	0
6593	01880	42.5015	-71.0675	6.9	8618	2022	40	180	0
8779	01742	42.4629	-71.3645	6.72	7988	2016	45	180	1
64230	01775	42.4297	-71.5125	11.52	13869	2024	37	180	1
58546	02053	42.1562	-71.4303	10.23	12225	2024	1	180	1
14263	01519	42.2034	-71.6797	6.24	7162	2022	30	0	0
22194	01742	42.4629	-71.3645	10.2	8977	2022	1	180	0
50163	01887	42.5646	-71.1645	9.3	11603	2024	34	180	0
10664	01742	42.4629	-71.3645	9.36	7577	2022	45	180	1
68114	02466	42.3445	-71.2486	14.49	14802	2024	30	135	2
33217	01810	42.648	-71.1618	10.486	9251	2021	1	135	1
44771	01069	42.1889	-72.3065	8.37	9644	2024	20	153	0
43549	02090	42.2196	-71.2168	10.005	8917	2023	24	217	2
6307	01810	42.648	-71.1618	10.72	12569	2024	20	135	0
67513	01827	42.6761	-71.4998	12.6	13568	2022	1	180	1
64930	03045	43.0215	-71.5635	11.2	10698	2025	25	121	1
38478	03087	42.8111	-71.3027	7.83	8860	2021	40	135	1
45775	03053	42.8698	-71.3878	5.3	6005	2023	24	243	0
8925	03110	42.9356	-71.5369	5.28	3997	2022	23	180	1
99802	03087	42.8111	-71.3027	19.2	18278	2024	0	0	0
27736	03245	43.7618	-71.5825	4.8	4193	2020	30	199	2
81478	03884	43.2754	-71.17	8.4	9831	2024	45	180	1
50996	03748	43.5891	-72.1321	9.45	6278	2019	25	0	1
91089	03278	43.3089	-71.8355	6.15	7186	2025	15.26	180	0
102299	03054	42.852	-71.5199	13.6	13150	2024	0	225	0
73809	03824	43.1171	-70.9188	10.725	12591	2020	30	225	0
91476	03602	43.1408	-72.3476	5.67	6698	2025	30	0	0
88956	03276	43.431	-71.576	8.5	8137	2022	39.8	0	0
61613	03824	43.1171	-70.9188	4.48	4758	2019	45	0	1"""


def train_and_save_model():
    """Train Ridge regression model and save to models directory."""

    print("Loading training data...")
    df = pd.read_csv(StringIO(DATA_STR), sep='\t')
    print(f"  Loaded {len(df)} records from {df['system_id'].nunique()} unique systems")

    # Feature engineering
    print("\nEngineering features...")
    df['azimuth_deviation'] = np.abs(df['azimuth'] - 180)
    df['tilt_deviation'] = np.abs(df['tilt'] - df['latitude'])

    # Features for the model (simplified - no system_age since year is production year)
    feature_cols = [
        'latitude', 'longitude', 'dc_capacity_kW', 'tilt', 'azimuth', 'shade',
        'azimuth_deviation', 'tilt_deviation'
    ]

    print(f"  Features: {feature_cols}")

    # Prepare data
    X = df[feature_cols].values
    y = df['annual_production_kwh'].values
    system_ids = df['system_id'].values

    # Group-aware train/test split
    print("\nSplitting data (group-aware by system_id)...")
    gss = GroupShuffleSplit(n_splits=1, test_size=0.2, random_state=42)
    train_idx, test_idx = next(gss.split(X, y, groups=system_ids))

    X_train, X_test = X[train_idx], X[test_idx]
    y_train, y_test = y[train_idx], y[test_idx]

    print(f"  Train: {len(X_train)} samples")
    print(f"  Test: {len(X_test)} samples")

    # Scale features (required for Ridge)
    print("\nScaling features...")
    scaler = StandardScaler()
    X_train_scaled = scaler.fit_transform(X_train)
    X_test_scaled = scaler.transform(X_test)

    # Train Ridge model
    print("\nTraining Ridge Regression model...")
    model = Ridge(alpha=1.0, random_state=42)
    model.fit(X_train_scaled, y_train)

    # Evaluate
    y_pred_train = model.predict(X_train_scaled)
    y_pred_test = model.predict(X_test_scaled)

    train_r2 = r2_score(y_train, y_pred_train)
    test_r2 = r2_score(y_test, y_pred_test)
    test_mae = mean_absolute_error(y_test, y_pred_test)
    test_rmse = np.sqrt(mean_squared_error(y_test, y_pred_test))

    print("\n" + "=" * 50)
    print("MODEL PERFORMANCE")
    print("=" * 50)
    print(f"  Train R2:  {train_r2:.4f}")
    print(f"  Test R2:   {test_r2:.4f}")
    print(f"  Test MAE:  {test_mae:,.0f} kWh")
    print(f"  Test RMSE: {test_rmse:,.0f} kWh")

    # Feature coefficients
    print("\nFeature Coefficients:")
    for feat, coef in sorted(zip(feature_cols, model.coef_), key=lambda x: abs(x[1]), reverse=True):
        print(f"  {feat:25s}: {coef:+.2f}")

    # Save model package
    print("\nSaving model...")
    model_package = {
        'model': model,
        'scaler': scaler,
        'feature_cols': feature_cols,
        'metrics': {
            'train_r2': train_r2,
            'test_r2': test_r2,
            'test_mae': test_mae,
            'test_rmse': test_rmse
        }
    }

    # Ensure models directory exists
    os.makedirs('models', exist_ok=True)
    model_path = 'models/ridge_model.joblib'
    joblib.dump(model_package, model_path)
    print(f"  Saved to: {model_path}")

    print("\n" + "=" * 50)
    print("TRAINING COMPLETE")
    print("=" * 50)

    return model_package


if __name__ == '__main__':
    train_and_save_model()
